import Papa from 'papaparse';
import { Machine } from '../types/machine';

export const parseMachineCSVData = (csvText: string): Omit<Machine, 'id'>[] => {
  const results = Papa.parse(csvText, {
    header: true,
    delimiter: ';',
    skipEmptyLines: true,
    transformHeader: (header: string) => {
      // Map CSV headers to our machine fields
      const headerMap: Record<string, keyof Machine> = {
        'Order Nr.': 'orderNr',
        'CODIGO': 'codigo',
        'CODIGO ': 'codigo', // Handle extra space
        'DESCRIPCION': 'descripcion',
        'DESCRIPCIÓN': 'descripcion',
        'CHASIS': 'chasis',
        'P.O': 'po',
        'Model': 'model',
        'Plant': 'plant',
        'Order Price (per unit)': 'orderPrice',
        'TOTAL (per unit)': 'totalPerUnit',
        'TOTAL AMOUNT USD': 'totalAmountUSD',
        'NC': 'nc',
        'CUADRO TF DE:': 'cuadroTfDe',
        'ESTADO': 'estado',
        'LLEGADA': 'llegada',
        'LLEGADA ': 'llegada', // Handle extra space
        'UBICACIÓN': 'ubicacion',
        'UBICACI�N': 'ubicacion' // Handle encoding issues
      };
      
      return headerMap[header.trim()] || header.toLowerCase().replace(/[^a-z0-9]/g, '');
    }
  });

  return results.data.map((row: any) => {
    // Helper function to parse numeric values
    const parseNumeric = (value: any): number => {
      if (!value) return 0;
      // Handle European number format (comma as decimal separator, period as thousands separator)
      const str = value.toString()
        .replace(/\./g, '') // Remove thousands separators (periods)
        .replace(/,/g, '.') // Convert decimal comma to period
        .replace(/[^\d.-]/g, ''); // Remove any other non-numeric characters
      const num = parseFloat(str);
      return isNaN(num) ? 0 : num;
    };

    return {
      orderNr: (row.orderNr || '').toString().trim(),
      codigo: (row.codigo || '').toString().trim(),
      descripcion: (row.descripcion || '').toString().trim(),
      chasis: (row.chasis || '').toString().trim(),
      po: (row.po || '').toString().trim(),
      model: (row.model || '').toString().trim(),
      plant: (row.plant || '').toString().trim(),
      orderPrice: parseNumeric(row.orderPrice),
      totalPerUnit: parseNumeric(row.totalPerUnit),
      totalAmountUSD: parseNumeric(row.totalAmountUSD),
      nc: parseNumeric(row.nc),
      cuadroTfDe: (row.cuadroTfDe || '').toString().trim(),
      estado: (row.estado || '').toString().trim(),
      llegada: (row.llegada || '').toString().trim(),
      ubicacion: (row.ubicacion || '').toString().trim(),
      link: ''
    };
  }).filter(machine => machine.codigo); // Filter out empty machines
};

// Initial CSV data for machines
export const initialMachineCSVData = `Order Nr.;CODIGO ;DESCRIPCION;CHASIS;P.O;Model;Plant;Order Price (per unit);TOTAL (per unit);TOTAL AMOUNT USD;NC;CUADRO TF DE:;ESTADO;LLEGADA ;UBICACI�N
PC033/2025;010200229;PUMA 230 18X6 FPS PILOT DUAL RAD 600/65R28 R1W X 20.8R42 R1W 2025;HCCZC230KSCN82293;004743;P23EC6;Curitiba;116.820,00;116.820,00;116.820,00;5.841,00;feb-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC033/2025;010200231;PUMA 230 18X6 FPS PILOT DUAL RAD 600/65R28 R1W X 20.8R42 R1W 2025;HCCZC230JSCN82070;004741;P23EC6;Curitiba;116.820,00;116.820,00;116.820,00;5.841,00;feb-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC033/2025;010100063;AXIAL FLOW 4160 4X2 NIVELANTE DUAL KIT TRIGO;JHFY4160CRJG26726;005419;ME4BLL;Sorocaba;190.716,00;190.716,00;190.716,00;12.351,00;feb-25;Facturado;ENTREGADO;
PC037/2025;010200203;PUMA 140 SPS 18X6 PILOT SING DIAG 16.9-28 8PR X 24.5-32 12PR R1 2024;HCCZC140LRCN78240;007419;PU40EC;Curitiba;70.200,00;70.200,00;70.200,00;5.616,00;mar-25;Facturado;ENTREGADO;
PC038/2025;010200251;PUMA 140 SPS 18X6 PRED SING DIAG 16.9-28 8PR X 24.5-32 12PR R1 2024;HCCZC140ERCN78256;007421;PU40EC;Curitiba;70.200,00;70.200,00;70.200,00;5.616,00;mar-25;En Stock - Libre;EN CIABAY;KATUETE
PC058/2024;010200043;FARMALL A 130 PS 16X8 PRED SING DIAG 14.9X28 R1 8PR X 23.1X30 R1 12PR 2024;HCCZ3F30LRCG75813;007413;F84CC7;Curitiba;59.475,00;59.475,00;59.475,00;5.947,50;mar-25;Facturado;ENTREGADO;
PC059/2024;010200044;FARMALL A 130 PS 16X8 PRED SING DIAG 14.9X28 R1 8PR X 23.1X30 R1 12PR 2024;HCCZ3F30HRCG75974;007414;F84CC7;Curitiba;59.475,00;59.475,00;59.475,00;5.947,50;mar-25;Facturado;ENTREGADO;
PC061/2024;010200046;FARMALL A 130 PS 16X8 PRED SING DIAG 14.9X28 R1 8PR X 23.1X30 R1 12PR 2024;HCCZ3F30HRCG74453;007415;F84CC7;Curitiba;59.475,00;59.475,00;59.475,00;5.947,50;mar-25;En Stock - Libre;EN CIABAY;MATRIZ
PC054/2024;010200039;PUMA 155 SPS 18X6 PRED DUAL DIAG 16.9-28 8PR X 20.8-38 10PR R1 2024;HCCZC155LRCN75414;007416;PU55EC;Curitiba;75.725,00;75.725,00;75.725,00;6.058,00;mar-25;En Stock - Libre;EN CIABAY;MATRIZ
PC012/2024;010300013;PATRIOT 350 36M 35CM 9 CORTE SECCION BOOM PILOT 2024;PRCYP350LRPC07172;007417;S3503B;Piracicaba;232.140,00;232.140,00;232.140,00;41.785,20;mar-25;Facturado;ENTREGADO;
PC017/2024;010300018;PATRIOT 350 36M 35CM 9 CORTE SECCION BOOM PILOT 2024;PRCYP350KRPC07200;007420;S3503B;Piracicaba;232.140,00;232.140,00;232.140,00;41.785,20;mar-25;Facturado;ENTREGADO;
PC009/2025;010200213;PUMA 200 18X6 FPS PILOT SING RAD 600/65R28 R1W X 710/70R38 R1W 2025;HCCZC200ESCN82793;004489;P20EC6;Curitiba;90.024,00;90.024,00;90.024,00;10.666,00;mar-25;Facturado;ENTREGADO;
PC040/2025;020900044;PLATAFORMA CONVENCIONAL TERRAFLEX 3020 25 PIES;HCCB252KLRC331848;007621;3C25FS;Curitiba;32.130,00;32.130,00;32.130,00;1.285,20;mar-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC041/2025;020900045;PLATAFORMA CONVENCIONAL TERRAFLEX 3020 25 PIES;HCCB252KLRC331851;007622;3C25FS;Curitiba;32.130,00;32.130,00;32.130,00;1.285,20;mar-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC042/2025;010300014;PATRIOT 350 36M 50CM 9 CORTE SECCION BOOM PILOT STD 2024;PRCYP350TRPC07517;007620;S3503B;Curitiba;218.800,00;218.800,00;218.800,00;39.398,40;mar-25;En Stock - Libre;EN CIABAY;MATRIZ
PC043/2025;010300015;PATRIOT 350 36M 50CM 9 CORTE SECCION BOOM PILOT STD PLUS 2024;PRCYP350ERPC07482;007618;S3503B;Curitiba;218.880,00;218.800,00;218.800,00;40.024,80;mar-25;Facturado;ENTREGADO;
PC046/2025;010200272;FARMALL 100 PS 12X12 PALA NP SING DIAG 14.924 6PR X 18.4X34 R1 10PR 2025;HCCZFA10TSCJ83157;009529;FP10C4;Curitiba;49.140,00;49.140,00;49.140,00;2.948,40;abr-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC047/2025;010200273;FARMALL 100 PS 12X12 PALA NP SING DIAG 14.924 6PR X 18.4X34 R1 10PR 2025;HCCZFA10ESCJ83110;009530;FP10C4;Curitiba;49.140,00;49.140,00;49.140,00;2.948,40;abr-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC062/2024;010200047;FARMALL A 130 PS 16X8 PRED SING DIAG 14.9X28 R1 8PR X 23.1X30 R1 12PR 2024;HCCZ3F30CRCG75637;006313;F84CC7;Curitiba;59.475,00;59.475,00;59.475,00;5.947,50;abr-25;En Stock - Libre;EN CIABAY;KATUETE
PC064/2024;010200050;FARMALL A 130 PS 16X8 PRED SING DIAG 14.9X28 R1 8PR X 23.1X30 R1 12PR 2024;HCCZ3F30PRCG77214;009528;F84CC7;Curitiba;59.475,00;59.475,00;59.475,00;5.947,50;abr-25;En Stock - Libre;EN CIABAY;MATRIZ
PC066/2024;010200051;FARMALL A 130 PS 16X8 PRED SING DIAG 14.9X28 R1 8PR X 23.1X30 R1 12PR 2024;HCCZ3F30CRCG77234;006349;F84CC7;Curitiba;59.475,00;59.475,00;59.475,00;5.947,50;abr-25;En Stock - Libre;EN CIABAY;MATRIZ
PC033/2024;010200262;PUMA 230 18X6 FPS PILOT DUAL RAD 600/65R28 R1W X 20.8R42 R1W 2025;HCCZC230LSCN82804;008100;P23EC6;Curitiba;116.820,00;116.820,00;116.820,00;5.841,00;abr-25;STOCK - En Conferencia - Libre;EN CIABAY;SAN ALBERTO
PC003/2025;010200217;PUMA 140 SPS 18X6 PRED SING RAD 600/55-30.5 X 710/65R38 2025;HCCZC140PSCN85024;004482;PU40EC;Curitiba;76.115,00;76.115,00;76.115,00;6.089,20;abr-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC005/2025;010200215;PUMA 140 SPS 18X6 PRED DUAL DIAG 16.9-28 8PR X 20.8-38 10PR R1 2025;HCCZC140TSCN84986;004486;PU40EC;Curitiba;73.060,00;73.060,00;73.060,00;5.844,80;abr-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC014/2025;010200221;FARMALL A 130 PS 16X8 PILOT DUAL DIAG 12.4X24 10PR R1 X 13.6-38 R1 14PR 2025;HCCZ3F30LSCG84724;004503;F84CC7;Curitiba;70.980,00;70.980,00;70.980,00;7.098,00;abr-25;En Stock - Libre;EN CIABAY;MATRIZ
PC019/2025;010200256;PUMA 200 18X6 FPS PRED DUAL RAD 600/65R28 R1W X 20.8R42 R1W 2025;HCCZC200ASCN82305;007747;P20EC6;Curitiba;94.380,00;94.380,00;94.380,00;9.438,00;abr-25;STOCK - En Conferencia - Libre;EN CIABAY;SANTA RITA
PC003/2025;010200199;PUMA 140 SPS 18X6 PRED SING RAD 600/55-30.5 X 710/65R38 2025;HCCZC140ASCN85077;004454;PU40EC;Curitiba;73.060,00;73.060,00;73.060,00;5.114,20;may-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC007/2025;010200194;PUMA 170 SPS 18X6 PRED SING RAD 16.9R28 X 20.8R38 R1W 2025;HCCZC170JSCN85359;004447;PU70EC;Curitiba;77.025,00;77.025,00;77.025,00;5.391,75;may-25;IDA3 - En Conferencia - Libre;EN CIABAY;MATRIZ
PC017/2025;010200223;PUMA 155 SPS 18X6 PRED SING RAD 600/55-30.5 X 710/65R38 2025;HCCZC155PSCN85700;004500;PU55EC;Curitiba;76.570,00;76.570,00;76.570,00;5.359,90;may-25;Facturado;ENTREGADO;BELLA VISTA
PC017/2025;010200225;PUMA 155 SPS 18X6 PILOT SING RAD 600/55-30.5 X 710/65R38 2025;HCCZC155ESCN85708;004501;PU55EC;Curitiba;76.570,00;76.570,00;76.570,00;5.359,90;may-25;Facturado;ENTREGADO;BELLA VISTA
PC048/2025;010200275;MAGNUM 380 CVT PILOT DUAL DUAL 480/70R34 X 710/70R42 2024;JJAMK380TRRK03045;010562;M38R2C;;267.036,00;267.036,00;267.036,00;26.703,60;may-25;DISPONIBLE EMBARQUE - Libre;01-ago;
PC048/2025;010200276;MAGNUM 380 CVT PILOT DUAL DUAL 480/70R34 X 710/70R42 2024;JAMK380VRRK03019;010563;M38R2C;;267.036,00;267.036,00;267.036,00;26.703,60;may-25;DISPONIBLE EMBARQUE - Libre;01-ago;
PC026/2025;010200241;PUMA 200 18X6 FPS PILOT SING RAD 600/65R28 R1W X 710/70R38 R1W 2025;HCCZC200KSCN86090;006379;;Curitiba;96.720,00;96.720,00;96.720,00;6770.40;may-25;Facturado;ENTREGADO;
PC010/2024;010300011;PATRIOT 350 36M 50CM AIM COMMAND BOOM PILOT 2024;PRCYP350LRPC07169;006311;S3503B;Piracicaba;271.080,00;271.080,00;271.080,00;27.108,00;jun-25;DISPONIBLE EMBARQUE - Libre;;
PC006/2025;010200197;PUMA 155 SPS 18X6 PRED SING DIAG 18.4-26 12PR R1 X 24.5-32 12PR R1 2025;HCCZC155JSCN86915;004441;PU55EC;Curitiba;71.760,00;71.760,00;71.760,00;5.023,20;jun-25;DISPONIBLE EMBARQUE - Libre;;
PC015/2025;010200224;FARMALL A 130 PS 16X8 PILOT DUAL DIAG 14.9X28 R1 8PR X 18.4-38 10PR R1 2025;HCCZ3F30CSCG86966;004518;F84CC7;Curitiba;69.875,00;69.875,00;69.875,00;4.891,25;jun-25;P. C. Importacion - Libre;;
PC016/2025;010200201;PUMA 140 SPS 18X6 PRED SING DIAG 16.9-28 8PR X 24.5-32 12PR R1 2025;HCCZC140ESCN87190;013284;PU40EC;Curitiba;68.770,00;68.770,00;68.770,00;4.813,90;jun-25;P. C. Importacion - Libre;;
PC026/2025;010200240;PUMA 200 18X6 FPS PILOT SING RAD 600/65R28 R1W X 710/70R38 R1W 2025;HCCZC200TSCN87267;012247;P20EC6;Curitiba;96.720,00;96.720,00;96.720,00;6.770,40;jun-25;DISPONIBLE EMBARQUE - Libre;;`;